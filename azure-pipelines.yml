trigger:
  - develop

pool:
  name: KataKombs
  demands:
    - agent.name -equals GameServiceAgent

variables:
  - group: DungonCrawlerGameService
  - name: BRANCH_NAME
    value: $[replace(variables['Build.SourceBranchName'], '/', '-')]
  - name: DOCKER_IMAGE_NAME
    value: '$(HARBOR_REGISTRY)/$(HARBOR_PROJECT)/$(BRANCH_NAME)'

stages:
  - stage: Quality
    displayName: 'üß™ Code Quality'
    jobs:
      - job: TestOnly
        displayName: 'Run Tests'
        steps:
          - script: |
              echo "Aucun test pour l'instant, √† int√©grer plus tard ..."

  - stage: Build
    displayName: 'üê≥ Build & Push'
    dependsOn: Quality
    condition: succeeded()
    jobs:
      - job: DockerBuild
        displayName: 'Build Docker Image'
        steps:
          # 1. Login Harbor
          - script: |
              echo "Connexion √† Harbor..."
              echo $(HARBOR_PASSWORD) | docker login $(HARBOR_URL) -u $(HARBOR_USERNAME) --password-stdin
            displayName: 'Docker Login'
            env:
              HARBOR_PASSWORD: $(HARBOR_PASSWORD)

          # 2. Build avec injection du Token NuGet
          - script: |
              echo "Construction de l'image..."
              echo "DOCKER IMAGE NAME = "$(DOCKER_IMAGE_NAME)
              
              # On passe le System.AccessToken √† l'argument d√©fini dans le Dockerfile
              # --progress=plain permet de voir toute l'erreur en cas de p√©pin
              docker build --progress=plain \
                --build-arg NUGET_AUTH_TOKEN=$(System.AccessToken) \
                -t $(DOCKER_IMAGE_NAME):latest .
            displayName: 'Docker Build'

          # 3. Tagging
          - script: |
              COMMIT_ID=$(Build.SourceVersion)
              SHORT_COMMIT_ID=${COMMIT_ID:0:8}
              echo "Tagging avec l'ID du commit : $SHORT_COMMIT_ID"
              docker tag $(DOCKER_IMAGE_NAME):latest $(DOCKER_IMAGE_NAME):$SHORT_COMMIT_ID
              echo "##vso[task.setvariable variable=SHORT_COMMIT_ID]$SHORT_COMMIT_ID"
            displayName: 'Tag Docker Image'

          # 4. Push
          - script: |
              echo "Envoi vers Harbor..."
              docker push $(DOCKER_IMAGE_NAME):latest
              docker push $(DOCKER_IMAGE_NAME):$SHORT_COMMIT_ID
            displayName: 'Docker Push'